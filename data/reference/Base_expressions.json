{
  "calc_area_ha": "round(\"area_value\" / 10000, 4)",
  "coord_top_left_x": "with_variable('layer_bounds', bounds(aggregate('L_1_1_1_Границы_работ','collect',$geometry)), x_min(@layer_bounds) + (x_max(@layer_bounds) - x_min(@layer_bounds)) * 0.05)",
  "coord_top_left_y": "with_variable('layer_bounds', bounds(aggregate('L_1_1_1_Границы_работ','collect',$geometry)), y_max(@layer_bounds) - (y_max(@layer_bounds) - y_min(@layer_bounds)) * 0.05)",
  "coord_top_right_x": "with_variable('layer_bounds', bounds(aggregate('L_1_1_1_Границы_работ','collect',$geometry)), x_max(@layer_bounds) - (x_max(@layer_bounds) - x_min(@layer_bounds)) * 0.05)",
  "coord_top_right_y": "with_variable('layer_bounds', bounds(aggregate('L_1_1_1_Границы_работ','collect',$geometry)), y_max(@layer_bounds) - (y_max(@layer_bounds) - y_min(@layer_bounds)) * 0.05)",
  "coord_bottom_left_x": "with_variable('layer_bounds', bounds(aggregate('L_1_1_1_Границы_работ','collect',$geometry)), x_min(@layer_bounds) + (x_max(@layer_bounds) - x_min(@layer_bounds)) * 0.05)",
  "coord_bottom_left_y": "with_variable('layer_bounds', bounds(aggregate('L_1_1_1_Границы_работ','collect',$geometry)), y_min(@layer_bounds) + (y_max(@layer_bounds) - y_min(@layer_bounds)) * 0.05)",
  "coord_bottom_right_x": "with_variable('layer_bounds', bounds(aggregate('L_1_1_1_Границы_работ','collect',$geometry)), x_max(@layer_bounds) - (x_max(@layer_bounds) - x_min(@layer_bounds)) * 0.05)",
  "coord_bottom_right_y": "with_variable('layer_bounds', bounds(aggregate('L_1_1_1_Границы_работ','collect',$geometry)), y_min(@layer_bounds) + (y_max(@layer_bounds) - y_min(@layer_bounds)) * 0.05)",
  "calc_label_offset": "@map_scale / 100000",
  "calc_bisector_azimuth": "with_variable('poly', geometry(get_feature_by_id(@polygon_layer, \"polygon_id\")), with_variable('idx', \"vertex_index\", with_variable('n', num_points(@poly) - 1, with_variable('prev', point_n(@poly, if(@idx = 1, @n, @idx - 1)), with_variable('next', point_n(@poly, if(@idx >= @n, 1, @idx + 1)), (degrees(azimuth(@prev, $geometry)) + degrees(azimuth($geometry, @next))) / 2 + 180)))))",
  "calc_has_neighbor_outside": "with_variable('test_pt', project($geometry, @map_scale / 50000, radians(eval(@calc_bisector_azimuth))), array_length(overlay_contains(@polygon_layer, expression:=$id, filter:=$id != \"polygon_id\")) > 0)",
  "calc_point_label_x": "x(project($geometry, eval(@calc_label_offset), radians(eval(@calc_bisector_azimuth))))",
  "calc_point_label_y": "y(project($geometry, eval(@calc_label_offset), radians(eval(@calc_bisector_azimuth))))",
  "calc_map_scale": "with_variable('layer_extent', bounds(aggregate('L_1_1_1_Границы_работ','collect',$geometry)), with_variable('max_extent', max(x_max(@layer_extent) - x_min(@layer_extent), y_max(@layer_extent) - y_min(@layer_extent)), with_variable('raw_scale', @max_extent * 5, with_variable('magnitude', floor(log10(@raw_scale)), with_variable('normalized', @raw_scale / pow(10, @magnitude), CASE WHEN @normalized <= 1 THEN pow(10, @magnitude) WHEN @normalized <= 2 THEN 2 * pow(10, @magnitude) WHEN @normalized <= 5 THEN 5 * pow(10, @magnitude) ELSE pow(10, @magnitude + 1) END)))))"
}